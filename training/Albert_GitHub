{"nbformat":4,"nbformat_minor":0,"metadata":{"colab":{"name":"Albert_GitHub","provenance":[{"file_id":"1zAHFlVFMnSYVVwP10WxmyFrMx-jzfApp","timestamp":1628787444794},{"file_id":"184w36OI_yqrVbP9YHJID7OhgeU_8PRQa","timestamp":1628782635353}]},"kernelspec":{"name":"python3","display_name":"Python 3"},"language_info":{"name":"python"},"accelerator":"GPU","widgets":{"application/vnd.jupyter.widget-state+json":{"6b8ea3662f2947e5a5d720e52f611575":{"model_module":"@jupyter-widgets/controls","model_name":"HBoxModel","model_module_version":"1.5.0","state":{"_view_name":"HBoxView","_dom_classes":[],"_model_name":"HBoxModel","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.5.0","box_style":"","layout":"IPY_MODEL_15ad8279ad9041efa1cde9416a7566f0","_model_module":"@jupyter-widgets/controls","children":["IPY_MODEL_fec406f3e4d04f1ead9b37cd7fa38fa8","IPY_MODEL_fc184f9290ae471eb4bee165ecda9cb7","IPY_MODEL_e378f85eabe64893ad0016b1b1e28c4e"]}},"15ad8279ad9041efa1cde9416a7566f0":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"fec406f3e4d04f1ead9b37cd7fa38fa8":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_view_name":"HTMLView","style":"IPY_MODEL_630135ded4ed46d7a35f5c7090a42580","_dom_classes":[],"description":"","_model_name":"HTMLModel","placeholder":"​","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":"100%","_view_count":null,"_view_module_version":"1.5.0","description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_475b551d0c004566be27cd471b19d1d7"}},"fc184f9290ae471eb4bee165ecda9cb7":{"model_module":"@jupyter-widgets/controls","model_name":"FloatProgressModel","model_module_version":"1.5.0","state":{"_view_name":"ProgressView","style":"IPY_MODEL_77ff1733bea74c5da07a37eda68a9def","_dom_classes":[],"description":"","_model_name":"FloatProgressModel","bar_style":"success","max":15625,"_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":15625,"_view_count":null,"_view_module_version":"1.5.0","orientation":"horizontal","min":0,"description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_f77c02e32369414d84312469b308a29c"}},"e378f85eabe64893ad0016b1b1e28c4e":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_view_name":"HTMLView","style":"IPY_MODEL_bba67a5cbdbb4fe0ac6a50fffc3de9c9","_dom_classes":[],"description":"","_model_name":"HTMLModel","placeholder":"​","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":" 15625/15625 [02:04&lt;00:00, 114.85ba/s]","_view_count":null,"_view_module_version":"1.5.0","description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_9f2e972ef3af455ca48287aa6b525f72"}},"630135ded4ed46d7a35f5c7090a42580":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_view_name":"StyleView","_model_name":"DescriptionStyleModel","description_width":"","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","_model_module":"@jupyter-widgets/controls"}},"475b551d0c004566be27cd471b19d1d7":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"77ff1733bea74c5da07a37eda68a9def":{"model_module":"@jupyter-widgets/controls","model_name":"ProgressStyleModel","model_module_version":"1.5.0","state":{"_view_name":"StyleView","_model_name":"ProgressStyleModel","description_width":"","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","bar_color":null,"_model_module":"@jupyter-widgets/controls"}},"f77c02e32369414d84312469b308a29c":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"bba67a5cbdbb4fe0ac6a50fffc3de9c9":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_view_name":"StyleView","_model_name":"DescriptionStyleModel","description_width":"","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","_model_module":"@jupyter-widgets/controls"}},"9f2e972ef3af455ca48287aa6b525f72":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}}}}},"cells":[{"cell_type":"markdown","metadata":{"id":"wJ4LiB_So76e"},"source":["# All"]},{"cell_type":"code","metadata":{"id":"EGawA05dBnAA"},"source":["from google.colab import auth\n","auth.authenticate_user()"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"QCIl1yUvroSm","executionInfo":{"status":"ok","timestamp":1628782710290,"user_tz":240,"elapsed":21354,"user":{"displayName":"Runa Cheng","photoUrl":"","userId":"13507466103787927113"}},"outputId":"2434104c-2c76-4b19-ea48-1cbff2cd7527"},"source":["from google.colab import drive\n","drive.mount('/content/drive')\n"],"execution_count":null,"outputs":[{"output_type":"stream","text":["Mounted at /content/drive\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"WXcX8T4Vhb37","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1628782716655,"user_tz":240,"elapsed":4733,"user":{"displayName":"Runa Cheng","photoUrl":"","userId":"13507466103787927113"}},"outputId":"2221f0d2-8a49-4cc1-843e-61c9863ccf92"},"source":["!pip install datasets"],"execution_count":null,"outputs":[{"output_type":"stream","text":["Collecting datasets\n","  Downloading datasets-1.11.0-py3-none-any.whl (264 kB)\n","\u001b[K     |████████████████████████████████| 264 kB 4.1 MB/s \n","\u001b[?25hRequirement already satisfied: dill in /usr/local/lib/python3.7/dist-packages (from datasets) (0.3.4)\n","Requirement already satisfied: importlib-metadata in /usr/local/lib/python3.7/dist-packages (from datasets) (4.6.1)\n","Requirement already satisfied: numpy>=1.17 in /usr/local/lib/python3.7/dist-packages (from datasets) (1.19.5)\n","Collecting fsspec>=2021.05.0\n","  Downloading fsspec-2021.7.0-py3-none-any.whl (118 kB)\n","\u001b[K     |████████████████████████████████| 118 kB 54.0 MB/s \n","\u001b[?25hCollecting huggingface-hub<0.1.0\n","  Downloading huggingface_hub-0.0.15-py3-none-any.whl (43 kB)\n","\u001b[K     |████████████████████████████████| 43 kB 2.6 MB/s \n","\u001b[?25hCollecting tqdm>=4.42\n","  Downloading tqdm-4.62.0-py2.py3-none-any.whl (76 kB)\n","\u001b[K     |████████████████████████████████| 76 kB 5.9 MB/s \n","\u001b[?25hRequirement already satisfied: pyarrow!=4.0.0,>=1.0.0 in /usr/local/lib/python3.7/dist-packages (from datasets) (3.0.0)\n","Requirement already satisfied: packaging in /usr/local/lib/python3.7/dist-packages (from datasets) (21.0)\n","Requirement already satisfied: requests>=2.19.0 in /usr/local/lib/python3.7/dist-packages (from datasets) (2.23.0)\n","Requirement already satisfied: multiprocess in /usr/local/lib/python3.7/dist-packages (from datasets) (0.70.12.2)\n","Requirement already satisfied: pandas in /usr/local/lib/python3.7/dist-packages (from datasets) (1.1.5)\n","Collecting xxhash\n","  Downloading xxhash-2.0.2-cp37-cp37m-manylinux2010_x86_64.whl (243 kB)\n","\u001b[K     |████████████████████████████████| 243 kB 52.8 MB/s \n","\u001b[?25hRequirement already satisfied: filelock in /usr/local/lib/python3.7/dist-packages (from huggingface-hub<0.1.0->datasets) (3.0.12)\n","Requirement already satisfied: typing-extensions in /usr/local/lib/python3.7/dist-packages (from huggingface-hub<0.1.0->datasets) (3.7.4.3)\n","Requirement already satisfied: pyparsing>=2.0.2 in /usr/local/lib/python3.7/dist-packages (from packaging->datasets) (2.4.7)\n","Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from requests>=2.19.0->datasets) (3.0.4)\n","Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.7/dist-packages (from requests>=2.19.0->datasets) (2.10)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.7/dist-packages (from requests>=2.19.0->datasets) (2021.5.30)\n","Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /usr/local/lib/python3.7/dist-packages (from requests>=2.19.0->datasets) (1.24.3)\n","Requirement already satisfied: zipp>=0.5 in /usr/local/lib/python3.7/dist-packages (from importlib-metadata->datasets) (3.5.0)\n","Requirement already satisfied: pytz>=2017.2 in /usr/local/lib/python3.7/dist-packages (from pandas->datasets) (2018.9)\n","Requirement already satisfied: python-dateutil>=2.7.3 in /usr/local/lib/python3.7/dist-packages (from pandas->datasets) (2.8.1)\n","Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.7/dist-packages (from python-dateutil>=2.7.3->pandas->datasets) (1.15.0)\n","Installing collected packages: tqdm, xxhash, huggingface-hub, fsspec, datasets\n","  Attempting uninstall: tqdm\n","    Found existing installation: tqdm 4.41.1\n","    Uninstalling tqdm-4.41.1:\n","      Successfully uninstalled tqdm-4.41.1\n","Successfully installed datasets-1.11.0 fsspec-2021.7.0 huggingface-hub-0.0.15 tqdm-4.62.0 xxhash-2.0.2\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"2WELNTlBBrQe","colab":{"base_uri":"https://localhost:8080/","height":1000},"executionInfo":{"status":"ok","timestamp":1628782757674,"user_tz":240,"elapsed":38090,"user":{"displayName":"Runa Cheng","photoUrl":"","userId":"13507466103787927113"}},"outputId":"74fbc803-1d22-417a-f67f-fa52dddf6534"},"source":["# %%capture\n","!pip install --force-reinstall git+https://github.com/runayhcheng/transformers.git"],"execution_count":null,"outputs":[{"output_type":"stream","text":["Collecting git+https://github.com/runayhcheng/transformers.git\n","  Cloning https://github.com/runayhcheng/transformers.git to /tmp/pip-req-build-b005qert\n","  Running command git clone -q https://github.com/runayhcheng/transformers.git /tmp/pip-req-build-b005qert\n","  Installing build dependencies ... \u001b[?25l\u001b[?25hdone\n","  Getting requirements to build wheel ... \u001b[?25l\u001b[?25hdone\n","    Preparing wheel metadata ... \u001b[?25l\u001b[?25hdone\n","Collecting huggingface-hub>=0.0.12\n","  Using cached huggingface_hub-0.0.15-py3-none-any.whl (43 kB)\n","Collecting regex!=2019.12.17\n","  Downloading regex-2021.8.3-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (722 kB)\n","\u001b[K     |████████████████████████████████| 722 kB 4.0 MB/s \n","\u001b[?25hCollecting numpy>=1.17\n","  Downloading numpy-1.21.1-cp37-cp37m-manylinux_2_12_x86_64.manylinux2010_x86_64.whl (15.7 MB)\n","\u001b[K     |████████████████████████████████| 15.7 MB 127 kB/s \n","\u001b[?25hCollecting requests\n","  Downloading requests-2.26.0-py2.py3-none-any.whl (62 kB)\n","\u001b[K     |████████████████████████████████| 62 kB 1.1 MB/s \n","\u001b[?25hCollecting sacremoses\n","  Downloading sacremoses-0.0.45-py3-none-any.whl (895 kB)\n","\u001b[K     |████████████████████████████████| 895 kB 66.3 MB/s \n","\u001b[?25hCollecting tokenizers<0.11,>=0.10.1\n","  Downloading tokenizers-0.10.3-cp37-cp37m-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (3.3 MB)\n","\u001b[K     |████████████████████████████████| 3.3 MB 55.4 MB/s \n","\u001b[?25hCollecting packaging\n","  Downloading packaging-21.0-py3-none-any.whl (40 kB)\n","\u001b[K     |████████████████████████████████| 40 kB 6.9 MB/s \n","\u001b[?25hCollecting importlib-metadata\n","  Downloading importlib_metadata-4.6.3-py3-none-any.whl (17 kB)\n","Collecting tqdm>=4.27\n","  Using cached tqdm-4.62.0-py2.py3-none-any.whl (76 kB)\n","Collecting pyyaml>=5.1\n","  Downloading PyYAML-5.4.1-cp37-cp37m-manylinux1_x86_64.whl (636 kB)\n","\u001b[K     |████████████████████████████████| 636 kB 69.0 MB/s \n","\u001b[?25hCollecting filelock\n","  Downloading filelock-3.0.12-py3-none-any.whl (7.6 kB)\n","Collecting typing-extensions\n","  Downloading typing_extensions-3.10.0.0-py3-none-any.whl (26 kB)\n","Collecting pyparsing>=2.0.2\n","  Downloading pyparsing-2.4.7-py2.py3-none-any.whl (67 kB)\n","\u001b[K     |████████████████████████████████| 67 kB 7.7 MB/s \n","\u001b[?25hCollecting zipp>=0.5\n","  Downloading zipp-3.5.0-py3-none-any.whl (5.7 kB)\n","Collecting urllib3<1.27,>=1.21.1\n","  Downloading urllib3-1.26.6-py2.py3-none-any.whl (138 kB)\n","\u001b[K     |████████████████████████████████| 138 kB 71.6 MB/s \n","\u001b[?25hCollecting idna<4,>=2.5\n","  Downloading idna-3.2-py3-none-any.whl (59 kB)\n","\u001b[K     |████████████████████████████████| 59 kB 8.8 MB/s \n","\u001b[?25hCollecting certifi>=2017.4.17\n","  Downloading certifi-2021.5.30-py2.py3-none-any.whl (145 kB)\n","\u001b[K     |████████████████████████████████| 145 kB 72.7 MB/s \n","\u001b[?25hCollecting charset-normalizer~=2.0.0\n","  Downloading charset_normalizer-2.0.4-py3-none-any.whl (36 kB)\n","Collecting click\n","  Downloading click-8.0.1-py3-none-any.whl (97 kB)\n","\u001b[K     |████████████████████████████████| 97 kB 9.1 MB/s \n","\u001b[?25hCollecting six\n","  Downloading six-1.16.0-py2.py3-none-any.whl (11 kB)\n","Collecting joblib\n","  Downloading joblib-1.0.1-py3-none-any.whl (303 kB)\n","\u001b[K     |████████████████████████████████| 303 kB 69.0 MB/s \n","\u001b[?25hBuilding wheels for collected packages: transformers\n","  Building wheel for transformers (PEP 517) ... \u001b[?25l\u001b[?25hdone\n","  Created wheel for transformers: filename=transformers-4.10.0.dev0-py3-none-any.whl size=2634415 sha256=16b47d8d1ad01f52cf1e5a200c62ebb70219617698a3db0eb26aa8733588b9b0\n","  Stored in directory: /tmp/pip-ephem-wheel-cache-53mmwoti/wheels/cc/21/e3/e3dba505872a63b24e5b5ae7076622eeb7d1f644a823040372\n","Successfully built transformers\n","Installing collected packages: zipp, typing-extensions, urllib3, pyparsing, importlib-metadata, idna, charset-normalizer, certifi, tqdm, six, requests, regex, packaging, joblib, filelock, click, tokenizers, sacremoses, pyyaml, numpy, huggingface-hub, transformers\n","  Attempting uninstall: zipp\n","    Found existing installation: zipp 3.5.0\n","    Uninstalling zipp-3.5.0:\n","      Successfully uninstalled zipp-3.5.0\n","  Attempting uninstall: typing-extensions\n","    Found existing installation: typing-extensions 3.7.4.3\n","    Uninstalling typing-extensions-3.7.4.3:\n","      Successfully uninstalled typing-extensions-3.7.4.3\n","  Attempting uninstall: urllib3\n","    Found existing installation: urllib3 1.24.3\n","    Uninstalling urllib3-1.24.3:\n","      Successfully uninstalled urllib3-1.24.3\n","  Attempting uninstall: pyparsing\n","    Found existing installation: pyparsing 2.4.7\n","    Uninstalling pyparsing-2.4.7:\n","      Successfully uninstalled pyparsing-2.4.7\n","  Attempting uninstall: importlib-metadata\n","    Found existing installation: importlib-metadata 4.6.1\n","    Uninstalling importlib-metadata-4.6.1:\n","      Successfully uninstalled importlib-metadata-4.6.1\n","  Attempting uninstall: idna\n","    Found existing installation: idna 2.10\n","    Uninstalling idna-2.10:\n","      Successfully uninstalled idna-2.10\n","  Attempting uninstall: charset-normalizer\n","    Found existing installation: charset-normalizer 2.0.2\n","    Uninstalling charset-normalizer-2.0.2:\n","      Successfully uninstalled charset-normalizer-2.0.2\n","  Attempting uninstall: certifi\n","    Found existing installation: certifi 2021.5.30\n","    Uninstalling certifi-2021.5.30:\n","      Successfully uninstalled certifi-2021.5.30\n","  Attempting uninstall: tqdm\n","    Found existing installation: tqdm 4.62.0\n","    Uninstalling tqdm-4.62.0:\n","      Successfully uninstalled tqdm-4.62.0\n","  Attempting uninstall: six\n","    Found existing installation: six 1.15.0\n","    Uninstalling six-1.15.0:\n","      Successfully uninstalled six-1.15.0\n","  Attempting uninstall: requests\n","    Found existing installation: requests 2.23.0\n","    Uninstalling requests-2.23.0:\n","      Successfully uninstalled requests-2.23.0\n","  Attempting uninstall: regex\n","    Found existing installation: regex 2019.12.20\n","    Uninstalling regex-2019.12.20:\n","      Successfully uninstalled regex-2019.12.20\n","  Attempting uninstall: packaging\n","    Found existing installation: packaging 21.0\n","    Uninstalling packaging-21.0:\n","      Successfully uninstalled packaging-21.0\n","  Attempting uninstall: joblib\n","    Found existing installation: joblib 1.0.1\n","    Uninstalling joblib-1.0.1:\n","      Successfully uninstalled joblib-1.0.1\n","  Attempting uninstall: filelock\n","    Found existing installation: filelock 3.0.12\n","    Uninstalling filelock-3.0.12:\n","      Successfully uninstalled filelock-3.0.12\n","  Attempting uninstall: click\n","    Found existing installation: click 7.1.2\n","    Uninstalling click-7.1.2:\n","      Successfully uninstalled click-7.1.2\n","  Attempting uninstall: pyyaml\n","    Found existing installation: PyYAML 3.13\n","    Uninstalling PyYAML-3.13:\n","      Successfully uninstalled PyYAML-3.13\n","  Attempting uninstall: numpy\n","    Found existing installation: numpy 1.19.5\n","    Uninstalling numpy-1.19.5:\n","      Successfully uninstalled numpy-1.19.5\n","  Attempting uninstall: huggingface-hub\n","    Found existing installation: huggingface-hub 0.0.15\n","    Uninstalling huggingface-hub-0.0.15:\n","      Successfully uninstalled huggingface-hub-0.0.15\n","\u001b[31mERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.\n","tensorflow 2.5.0 requires numpy~=1.19.2, but you have numpy 1.21.1 which is incompatible.\n","tensorflow 2.5.0 requires six~=1.15.0, but you have six 1.16.0 which is incompatible.\n","tensorflow 2.5.0 requires typing-extensions~=3.7.4, but you have typing-extensions 3.10.0.0 which is incompatible.\n","google-colab 1.0.0 requires requests~=2.23.0, but you have requests 2.26.0 which is incompatible.\n","google-colab 1.0.0 requires six~=1.15.0, but you have six 1.16.0 which is incompatible.\n","flask 1.1.4 requires click<8.0,>=5.1, but you have click 8.0.1 which is incompatible.\n","datascience 0.10.6 requires folium==0.2.1, but you have folium 0.8.3 which is incompatible.\n","albumentations 0.1.12 requires imgaug<0.2.7,>=0.2.5, but you have imgaug 0.2.9 which is incompatible.\u001b[0m\n","Successfully installed certifi-2021.5.30 charset-normalizer-2.0.4 click-8.0.1 filelock-3.0.12 huggingface-hub-0.0.15 idna-3.2 importlib-metadata-4.6.3 joblib-1.0.1 numpy-1.21.1 packaging-21.0 pyparsing-2.4.7 pyyaml-5.4.1 regex-2021.8.3 requests-2.26.0 sacremoses-0.0.45 six-1.16.0 tokenizers-0.10.3 tqdm-4.62.0 transformers-4.10.0.dev0 typing-extensions-3.10.0.0 urllib3-1.26.6 zipp-3.5.0\n"],"name":"stdout"},{"output_type":"display_data","data":{"application/vnd.colab-display-data+json":{"pip_warning":{"packages":["certifi","idna","numpy","pyparsing","requests","six","urllib3"]}}},"metadata":{"tags":[]}}]},{"cell_type":"code","metadata":{"id":"0W7MvbTjB2fp"},"source":["from transformers import EncoderDecoderModel, AlbertTokenizer, AlbertConfig, AlbertModel\n","import torch\n","import numpy as np"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"ypPLSYBqCTMU","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1628782769660,"user_tz":240,"elapsed":245,"user":{"displayName":"Runa Cheng","photoUrl":"","userId":"13507466103787927113"}},"outputId":"6bba94db-6f13-433e-ea83-c77f92a7c608"},"source":["if torch.cuda.is_available():\n","  device = torch.device('cuda')\n","  print(torch.cuda.get_device_name())\n","else:\n","  device = torch.device('cpu')\n","  "],"execution_count":null,"outputs":[{"output_type":"stream","text":["Tesla V100-SXM2-16GB\n"],"name":"stdout"}]},{"cell_type":"markdown","metadata":{"id":"7wurB7oMpAPh"},"source":["## Train"]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"3iJekoKc7P7h","executionInfo":{"status":"ok","timestamp":1628782782372,"user_tz":240,"elapsed":9802,"user":{"displayName":"Runa Cheng","photoUrl":"","userId":"13507466103787927113"}},"outputId":"709f5448-d300-4c2c-bb5c-7ba7c34709d6"},"source":["!pip install tokenizers\n","!pip install sentencepiece\n","!pip install Sentencepiece\n","from transformers import (\n","    AlbertForPreTraining,\n","    LineByLineTextDataset,\n","    TextDataset,\n","    DataCollatorForLanguageModeling,\n","    Trainer,\n","    TrainingArguments\n",")\n","import math\n"],"execution_count":null,"outputs":[{"output_type":"stream","text":["Requirement already satisfied: tokenizers in /usr/local/lib/python3.7/dist-packages (0.10.3)\n","Collecting sentencepiece\n","  Downloading sentencepiece-0.1.96-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (1.2 MB)\n","\u001b[K     |████████████████████████████████| 1.2 MB 4.1 MB/s \n","\u001b[?25hInstalling collected packages: sentencepiece\n","Successfully installed sentencepiece-0.1.96\n","Requirement already satisfied: Sentencepiece in /usr/local/lib/python3.7/dist-packages (0.1.96)\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"zNEiywff0DT_"},"source":["# !gsutil cp gs://cytereader/preprocessed_cell_corpus_0.txt . \n","# !gsutil cp gs://cytereader/preprocessed_cell_corpus_1.txt . "],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"UYwomabzTDJe"},"source":["# from tokenizers import BertWordPieceTokenizer"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"9Yt1575EUsT1","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1628782796947,"user_tz":240,"elapsed":2837,"user":{"displayName":"Runa Cheng","photoUrl":"","userId":"13507466103787927113"}},"outputId":"5173fb92-01a5-4fd5-abe4-8403f1c899d2"},"source":["!mkdir cellAttention\n","!gsutil cp gs://cytereader/vocab.txt cellAttention/"],"execution_count":null,"outputs":[{"output_type":"stream","text":["Copying gs://cytereader/vocab.txt...\n","/ [1 files][  978.0 B/  978.0 B]                                                \n","Operation completed over 1 objects/978.0 B.                                      \n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"0uTTACXO9A3D","executionInfo":{"status":"ok","timestamp":1628782800805,"user_tz":240,"elapsed":309,"user":{"displayName":"Runa Cheng","photoUrl":"","userId":"13507466103787927113"}},"outputId":"86fb7e01-ed13-4b0c-c268-5f20204794f1"},"source":["%%writefile cellAttention/config.json\n","{\n","  \"architectures\": [\n","    \"AlbertForMaskedLM\"\n","  ],\n","  \"attention_probs_dropout_prob\": 0,\n","  \"bos_token_id\": 2,\n","  \"classifier_dropout_prob\": 0.1,\n","  \"down_scale_factor\": 1,\n","  \"embedding_size\": 128,\n","  \"eos_token_id\": 3,\n","  \"gap_size\": 0,\n","  \"hidden_act\": \"gelu_new\",\n","  \"hidden_dropout_prob\": 0,\n","  \"hidden_size\": 768,\n","  \"initializer_range\": 0.02,\n","  \"inner_group_num\": 1,\n","  \"intermediate_size\": 3072,\n","  \"layer_norm_eps\": 1e-12,\n","  \"max_position_embeddings\": 512,\n","  \"model_type\": \"albert\",\n","  \"net_structure_type\": 0,\n","  \"num_attention_heads\": 12,\n","  \"num_hidden_groups\": 1,\n","  \"num_hidden_layers\": 12,\n","  \"num_memory_blocks\": 0,\n","  \"pad_token_id\": 0,\n","  \"type_vocab_size\": 2,\n","  \"vocab_size\": 1000\n","}"],"execution_count":null,"outputs":[{"output_type":"stream","text":["Writing cellAttention/config.json\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"_0GwpmP1JYVA","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1628782816625,"user_tz":240,"elapsed":289,"user":{"displayName":"Runa Cheng","photoUrl":"","userId":"13507466103787927113"}},"outputId":"64547db7-4d70-41bf-c187-a5aaf07a2a2e"},"source":["from transformers import BertConfig, AutoTokenizer, BertLMHeadModel, AlbertConfig\n","from transformers import AlbertForMaskedLM\n","from transformers import  BertTokenizer\n","from transformers.models.bert.tokenization_bert import CellBertTokenizer\n","\n","\n","configuration = AlbertConfig.from_json_file('cellAttention/config.json')\n","model = AlbertForMaskedLM(configuration)\n","tokenizer = CellBertTokenizer.from_pretrained('./cellAttention',vocab_file=\"./cellAttention/vocab.txt\")\n"],"execution_count":null,"outputs":[{"output_type":"stream","text":["The tokenizer class you load from this checkpoint is not the same type as the class this function is called from. It may result in unexpected tokenization. \n","The tokenizer class you load from this checkpoint is 'AlbertTokenizer'. \n","The class this function is called from is 'CellBertTokenizer'.\n"],"name":"stderr"}]},{"cell_type":"code","metadata":{"id":"VCO56A7snvwl"},"source":["%%capture\n","!mkdir otsu\n","!gsutil -m cp -r gs://cytereader/otsu/ otsu/"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/","height":133,"referenced_widgets":["6b8ea3662f2947e5a5d720e52f611575","15ad8279ad9041efa1cde9416a7566f0","fec406f3e4d04f1ead9b37cd7fa38fa8","fc184f9290ae471eb4bee165ecda9cb7","e378f85eabe64893ad0016b1b1e28c4e","630135ded4ed46d7a35f5c7090a42580","475b551d0c004566be27cd471b19d1d7","77ff1733bea74c5da07a37eda68a9def","f77c02e32369414d84312469b308a29c","bba67a5cbdbb4fe0ac6a50fffc3de9c9","9f2e972ef3af455ca48287aa6b525f72"]},"id":"Y9FoPjyIgqI-","executionInfo":{"status":"ok","timestamp":1628783093941,"user_tz":240,"elapsed":126433,"user":{"displayName":"Runa Cheng","photoUrl":"","userId":"13507466103787927113"}},"outputId":"6695890a-3c9c-41a7-9cee-407696d44eb9"},"source":["%%time\n","from transformers import LineByLineTextDataset\n","from datasets import load_dataset\n","import os \n","\n","# dataNameList = ['Z3YR-otsu.23.txt', 'Z23S-otsu.14.txt', 'Z23S-otsu.15.txt', 'Z3YR-otsu.22.txt', 'Z3YR-otsu.20.txt', 'Z23S-otsu.16.txt', 'Z3YR-otsu.21.txt', 'Z3YR-otsu.19.txt', 'Z23S-otsu.12.txt', 'Z23S-otsu.8.txt', 'Z23S-otsu.9.txt', 'Z23S-otsu.13.txt', 'Z3YR-otsu.18.txt', 'Z23S-otsu.11.txt', 'Z3YR-otsu.8.txt', 'Z3YR-otsu.9.txt', 'Z23S-otsu.10.txt', 'Z367-otsu.7.txt', 'Z2ZJ-otsu.txt', 'Z367-otsu.11.txt', 'Z367-otsu.10.txt', 'Z367-otsu.6.txt', 'Z367-otsu.4.txt', 'Z367-otsu.5.txt', 'Z367-otsu.1.txt', 'Z367-otsu.0.txt', 'Z367-otsu.2.txt', 'Z2L2-otsu.8.txt', 'Z367-otsu.3.txt', 'Z2L2-otsu.4.txt', 'Z2L2-otsu.5.txt', 'Z2L2-otsu.7.txt', 'Z2L2-otsu.6.txt', 'Z2L2-otsu.2.txt', 'Z367-otsu.8.txt', 'Z367-otsu.9.txt', 'Z2L2-otsu.3.txt', 'Z2L2-otsu.1.txt', 'Z2L2-otsu.0.txt', 'Z3YR-otsu.16.txt', 'Z3YR-otsu.4.txt', 'Z23S-otsu.7.txt', 'Z23S-otsu.6.txt', 'Z3YR-otsu.5.txt', 'Z3YR-otsu.17.txt', 'Z3YR-otsu.15.txt', 'Z3YR-otsu.7.txt', 'Z23S-otsu.4.txt', 'Z23S-otsu.5.txt', 'Z3YR-otsu.6.txt', 'Z3YR-otsu.14.txt', 'Z3YR-otsu.10.txt', 'Z3YR-otsu.2.txt', 'Z23S-otsu.1.txt', 'Z23S-otsu.0.txt', 'Z3YR-otsu.3.txt', 'Z3YR-otsu.11.txt', 'Z3YR-otsu.13.txt', 'Z3YR-otsu.1.txt', 'Z23S-otsu.2.txt', 'Z23S-otsu.3.txt', 'Z3YR-otsu.0.txt', 'Z3YR-otsu.12.txt']\n","# dataNameList_median = ['Z367-median.10.txt', 'Z367-median.11.txt', 'Z2ZJ-median.txt', 'Z3YR-median.5.txt', 'Z23S-median.2.txt', 'Z23S-median.3.txt', 'Z23S-median.16.txt', 'Z3YR-median.4.txt', 'Z3YR-median.19.txt', 'Z3YR-median.6.txt', 'Z23S-median.14.txt', 'Z23S-median.1.txt', 'Z23S-median.0.txt', 'Z23S-median.15.txt', 'Z3YR-median.7.txt', 'Z3YR-median.18.txt', 'Z3YR-median.20.txt', 'Z3YR-median.3.txt', 'Z23S-median.11.txt', 'Z23S-median.4.txt', 'Z23S-median.5.txt', 'Z23S-median.10.txt', 'Z2L2-median.8.txt', 'Z3YR-median.2.txt', 'Z3YR-median.21.txt', 'Z3YR-median.23.txt', 'Z3YR-median.0.txt', 'Z367-median.8.txt', 'Z23S-median.12.txt', 'Z23S-median.7.txt', 'Z23S-median.6.txt', 'Z23S-median.13.txt', 'Z367-median.9.txt', 'Z3YR-median.1.txt', 'Z3YR-median.22.txt', 'Z3YR-median.13.txt', 'Z2L2-median.6.txt', 'Z367-median.4.txt', 'Z367-median.5.txt', 'Z2L2-median.7.txt', 'Z3YR-median.12.txt', 'Z3YR-median.10.txt', 'Z2L2-median.5.txt', 'Z367-median.7.txt', 'Z23S-median.8.txt', 'Z23S-median.9.txt', 'Z367-median.6.txt', 'Z2L2-median.4.txt', 'Z3YR-median.11.txt', 'Z3YR-median.15.txt', 'Z2L2-median.0.txt', 'Z367-median.2.txt', 'Z367-median.3.txt', 'Z2L2-median.1.txt', 'Z3YR-median.14.txt', 'Z3YR-median.16.txt', 'Z3YR-median.9.txt', 'Z2L2-median.3.txt', 'Z367-median.1.txt', 'Z367-median.0.txt', 'Z2L2-median.2.txt', 'Z3YR-median.8.txt', 'Z3YR-median.17.txt']\n","\n","files_name = ['otsu/otsu/' + x for x in os.listdir('/content/otsu/otsu/')][0:2]\n","dataset = load_dataset(\"text\", data_files=files_name, split='train')\n","max_length = 64\n","batch_size=128\n","\n","def tokenize_function(examples):\n","    tokenizer_ = tokenizer([x.lower() for x in examples['text']], max_length=max_length, truncation=True, padding='max_length')\n","    return tokenizer_\n","\n","train_data_batch = dataset.map(\n","    tokenize_function, \n","    batched=True, \n","    batch_size=batch_size,\n",")"],"execution_count":null,"outputs":[{"output_type":"stream","text":["Using custom data configuration default-1bb67c8b5ce790c3\n","Reusing dataset text (/root/.cache/huggingface/datasets/text/default-1bb67c8b5ce790c3/0.0.0/e16f44aa1b321ece1f87b07977cc5d70be93d69b20486d6dacd62e12cf25c9a5)\n"],"name":"stderr"},{"output_type":"display_data","data":{"application/vnd.jupyter.widget-view+json":{"model_id":"6b8ea3662f2947e5a5d720e52f611575","version_minor":0,"version_major":2},"text/plain":["  0%|          | 0/15625 [00:00<?, ?ba/s]"]},"metadata":{"tags":[]}},{"output_type":"stream","text":["CPU times: user 2min 2s, sys: 2.76 s, total: 2min 5s\n","Wall time: 2min 6s\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"r1baFTpwBA3f"},"source":["from transformers.data.data_collator import DataCollatorForLanguageModeling, DataCollatorForSOP, DataCollatorForNetutralCellModeling\n","\n","data_collator = DataCollatorForNetutralCellModeling(\n","    tokenizer=tokenizer, ncm=True, mlm_probability=0.15\n",")"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"Fn_oz7tu9Q13"},"source":["from transformers import Trainer, TrainingArguments\n","\n","training_args = TrainingArguments(\n","    output_dir=\"./cellAttention\",\n","    overwrite_output_dir=True,\n","    num_train_epochs=1,\n","    per_device_train_batch_size=batch_size,\n","    save_steps=10_000,\n","    learning_rate=1e-4,\n","    save_total_limit=2,\n","    prediction_loss_only=True,\n",")\n","\n","trainer = Trainer(\n","    model=model,\n","    args=training_args,\n","    data_collator=data_collator,\n","    train_dataset=train_data_batch,\n",")"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/","height":718},"id":"FFuVpB_wMn_u","outputId":"209081d8-5def-4786-e3e6-8b9dfa56e412"},"source":["# %%time\n","trainer.train()"],"execution_count":null,"outputs":[{"output_type":"stream","text":["The following columns in the training set  don't have a corresponding argument in `AlbertForMaskedLM.forward` and have been ignored: text.\n","***** Running training *****\n","  Num examples = 2000000\n","  Num Epochs = 1\n","  Instantaneous batch size per device = 128\n","  Total train batch size (w. parallel, distributed & accumulation) = 128\n","  Gradient Accumulation steps = 1\n","  Total optimization steps = 15625\n"],"name":"stderr"},{"output_type":"display_data","data":{"text/html":["\n","    <div>\n","      \n","      <progress value='8786' max='15625' style='width:300px; height:20px; vertical-align: middle;'></progress>\n","      [ 8786/15625 1:12:14 < 56:14, 2.03 it/s, Epoch 0.56/1]\n","    </div>\n","    <table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: left;\">\n","      <th>Step</th>\n","      <th>Training Loss</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <td>500</td>\n","      <td>2.129400</td>\n","    </tr>\n","    <tr>\n","      <td>1000</td>\n","      <td>0.422300</td>\n","    </tr>\n","    <tr>\n","      <td>1500</td>\n","      <td>0.364600</td>\n","    </tr>\n","    <tr>\n","      <td>2000</td>\n","      <td>0.347300</td>\n","    </tr>\n","    <tr>\n","      <td>2500</td>\n","      <td>0.338000</td>\n","    </tr>\n","    <tr>\n","      <td>3000</td>\n","      <td>0.331300</td>\n","    </tr>\n","    <tr>\n","      <td>3500</td>\n","      <td>0.330600</td>\n","    </tr>\n","    <tr>\n","      <td>4000</td>\n","      <td>0.326100</td>\n","    </tr>\n","    <tr>\n","      <td>4500</td>\n","      <td>0.323400</td>\n","    </tr>\n","    <tr>\n","      <td>5000</td>\n","      <td>0.324600</td>\n","    </tr>\n","    <tr>\n","      <td>5500</td>\n","      <td>0.321900</td>\n","    </tr>\n","    <tr>\n","      <td>6000</td>\n","      <td>0.321100</td>\n","    </tr>\n","    <tr>\n","      <td>6500</td>\n","      <td>0.321300</td>\n","    </tr>\n","    <tr>\n","      <td>7000</td>\n","      <td>0.316300</td>\n","    </tr>\n","    <tr>\n","      <td>7500</td>\n","      <td>0.315600</td>\n","    </tr>\n","    <tr>\n","      <td>8000</td>\n","      <td>0.315700</td>\n","    </tr>\n","    <tr>\n","      <td>8500</td>\n","      <td>0.313700</td>\n","    </tr>\n","  </tbody>\n","</table><p>"],"text/plain":["<IPython.core.display.HTML object>"]},"metadata":{"tags":[]}}]},{"cell_type":"code","metadata":{"id":"YNfsthQO9WYk","colab":{"base_uri":"https://localhost:8080/","height":158},"executionInfo":{"status":"error","timestamp":1628733657997,"user_tz":240,"elapsed":1740,"user":{"displayName":"Runa Cheng","photoUrl":"","userId":"13507466103787927113"}},"outputId":"8bf32498-4cb2-4bf4-fac6-89a6f92a7faf"},"source":["trainer.save_model(\"./cellAttention\")"],"execution_count":null,"outputs":[{"output_type":"error","ename":"NameError","evalue":"ignored","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)","\u001b[0;32m<ipython-input-2-313bfd7769db>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m()\u001b[0m\n\u001b[0;32m----> 1\u001b[0;31m \u001b[0mtrainer\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0msave_model\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m\"./cellAttention\"\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m","\u001b[0;31mNameError\u001b[0m: name 'trainer' is not defined"]}]},{"cell_type":"code","metadata":{"id":"-iTFHpu6fvKN"},"source":["tokenizer.save_pretrained(\"./cellAttention\")"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"KaQacVClEQP8"},"source":["from transformers import pipeline\n","\n","fill_mask = pipeline(\n","    \"fill-mask\",\n","    model=\"./cellAttention\",\n","    tokenizer=\"./cellAttention\"\n",")"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"0K3jVx51f_pY"},"source":["fill_mask(\"CD45+ CD196_CCR6+ CD181_CXCR1- HLA_DR- CD15- CD31_PECAM1- CD8a- CD182_CXCR2[MASK] CD66ace- CD63- CD14- CD66b- CD62L_Lselectin- CD3+ CD27- CD86+ CD10- CD197_CCR7+ CD28- CD11c- CD33- CD161- CD45RO- CD24- CD38+ CD278_ICOS- CD32- CD152_CTLA4+ IgM+ CD184_CXCR4+ CD279_PD1- CD56+ CD16-\")"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"GU-Uqz46FfmS"},"source":["input = 'CD45+ CD196_CCR6+ CD181_CXCR1- HLA_DR- CD15-'\n","masked_input = 'CD45+ CD196_CCR6+ CD181_CXCR1[MASKED] HLA_DR- CD15-'\n","\n","output = 'CD45+ CD196_CCR6+ CD181_CXCR1-/+ HLA_DR- CD15-'"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"CPV14gq8DPOY"},"source":["!gsutil cp -r  /content/cellAttention/*.bin gs://cytereader/longphan/test_bert_0/\n","!gsutil cp -r  /content/cellAttention/config.json gs://cytereader/longphan/test_bert_0/\n","!gsutil cp -r  /content/cellAttention/vocab.txt gs://cytereader/longphan/test_bert_0/"],"execution_count":null,"outputs":[]}]}